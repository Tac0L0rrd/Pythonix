<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Pythonix</title>
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Base URL for API endpoints; leave blank for same origin (relative) -->
  <meta name="api-base" content="">
  <link rel="icon" href="favicon.ico" type="image/x-icon">
  <style>
    html, body {
      min-height: 100vh;
      margin: 0;
      font-family: 'Press Start 2P', 'Segoe UI', Arial, sans-serif;
      background: var(--bg, linear-gradient(135deg, #66b5ff 0%, #3863ff 100%));
      transition: background 0.4s;
      margin: 0;
      font-size: 1rem;
      color: #222;
      font-weight: 600;
      /* mimic current.com logo style */
      cursor: default;
    }

    /* --- Consolidated, improved navbar styles (replace duplicates) --- */
.navbar {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 14px;
  padding: 8px 12px;
  max-width: 1100px;
  margin: 18px auto;
  background: hsla(0,0%,100%,.05);
  border-radius: 12px;
  border: 1px solid hsla(0,0%,100%,.1);
  box-shadow: 0 10px 40px rgba(2, 6, 23, 0.55), inset 0 1px 0 rgba(255, 255, 255, 0.02);
  backdrop-filter: blur(12px) saturate(140%);
  transition: all .3s ease;
  position: sticky;
  top: 10px;
  z-index: 1000;
  will-change: transform, box-shadow;
}

.navbar:hover {
  transform: translateY(-2px);
  box-shadow: 0 20px 80px rgba(2, 6, 23, 0.65);
}

.navbar-brand {
  display: flex;
  align-items: center;
  gap: 12px;
  padding-right: 10px;
  border-right: 1px solid rgba(255, 255, 255, 0.03);
}

.navbar-brand h2 {
  margin: 0;
  color: #fff;
  font-size: 1rem;
  text-shadow: 0 6px 18px rgba(0, 0, 0, 0.45);
}

.nav-accent {
  display: none;
}

.navbar-controls {
  display: flex;
  flex-wrap: wrap;
  gap: 24px;
  align-items: flex-start;
  padding: 8px 16px;
  max-height: 0;
  opacity: 0;
  overflow: hidden;
  transition: all .3s ease 0.1s; /* Added 0.1s delay */
  will-change: opacity, max-height;
}

.navbar:hover .navbar-controls,
.navbar:focus-within .navbar-controls,
.navbar-controls:focus-within {
  max-height: 400px; /* Increased height for new layout */
  opacity: 1;
}

/* Control group styling */
.control-group {
  display: flex;
  flex-direction: column;
  gap: 8px;
  min-width: 0;
}

.group-title {
  font-size: 11px;
  font-weight: 700;
  color: rgba(255, 255, 255, 0.7);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: 4px;
  text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
}

.control-row {
  display: flex;
  flex-wrap: wrap;
  gap: 12px;
  align-items: center;
}

.stats-row {
  display: flex;
  flex-wrap: wrap;
  gap: 12px;
  align-items: center;
  margin-bottom: 8px;
}

.action-buttons {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
}

.navbar-controls label {
  background: transparent;
  padding: 8px 12px;
  border-radius: 10px;
  color: #e0e0e0;
  font-weight: 700;
  font-size: 0.85rem;
  text-shadow: none;
}

.navbar-controls select,
.navbar-controls input[type="text"] {
  background: rgba(255, 255, 255, 0.15);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: #ffffff;
  padding: 6px 8px;
  border-radius: 8px;
  font-weight: 600;
  font-size: 14px;
}

/* Improve dropdown visibility */
.navbar-controls select {
  background: rgba(40, 60, 80, 0.9);
  color: #ffffff;
  border: 1px solid rgba(255, 255, 255, 0.4);
}

.navbar-controls input[type="range"] {
  background: rgba(255, 255, 255, 0.15);
  border-radius: 8px;
  height: 6px;
  outline: none;
  -webkit-appearance: none;
  appearance: none;
  width: 80px;
  margin-right: 8px;
}

.navbar-controls input[type="range"]::-webkit-slider-thumb {
  -webkit-appearance: none;
  appearance: none;
  width: 16px;
  height: 16px;
  border-radius: 50%;
  background: #ffffff;
  cursor: pointer;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
}

.navbar-controls input[type="range"]::-moz-range-thumb {
  width: 16px;
  height: 16px;
  border-radius: 50%;
  background: #ffffff;
  cursor: pointer;
  border: none;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
}

.navbar-controls select:focus,
.navbar-controls input[type="text"]:focus {
  outline: none;
  border-color: rgba(255, 255, 255, 0.6);
  background: rgba(50, 70, 90, 0.95);
}

.navbar-controls input[type="text"]:focus {
  background: rgba(255, 255, 255, 0.25);
}

.navbar-controls select option {
  background: #2c3e50;
  color: #ffffff;
  padding: 8px;
  font-weight: 600;
}

.navbar-controls select option:hover {
  background: #34495e;
}

.navbar-controls label {
  color: #ffffff;
  font-weight: 600;
  text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
  font-size: 14px;
}

.small-btn {
  background: rgba(255, 255, 255, 0.2);
  color: #ffffff;
  border-radius: 10px;
  padding: 8px 12px;
  border: 1px solid rgba(255, 255, 255, 0.3);
  cursor: pointer;
  font-weight: 700;
  text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
  font-size: 14px;
  transition: all 0.2s ease;
}

.small-btn:hover {
  background: rgba(255, 255, 255, 0.3);
  transform: translateY(-1px);
}

.stat-item {
  color: #ffffff;
  font-weight: 600;
  text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
  font-size: 13px;
  padding: 4px 8px;
  background: rgba(255, 255, 255, 0.1);
  border-radius: 6px;
  border: 1px solid rgba(255, 255, 255, 0.2);
}

#emojiPicker {
  background: rgba(255, 255, 255, 0.2);
  border: 1px solid rgba(255, 255, 255, 0.4);
  color: #ffffff;
  text-align: center;
  font-size: 18px;
  width: 50px;
  padding: 6px;
  border-radius: 8px;
  font-family: 'Apple Color Emoji', 'Segoe UI Emoji', 'Noto Color Emoji', sans-serif;
}

/* ensure emoji picker stands out */
.emoji-picker {
  background: linear-gradient(180deg, #ffffff, #f2f2f2);
  padding: 4px 8px;
  border-radius: 8px;
  font-size: 1.05rem;
  cursor: pointer;
}

/* Amazing animated themes with special effects */
.theme-day { 
  background: linear-gradient(135deg, #87CEEB 0%, #98FB98 40%, #F0E68C 100%);
  --board-bg: #f7fffe;
  position: relative;
}
.theme-day::before {
  content: '';
  position: fixed;
  top: 0; left: 0;
  width: 100vw; height: 100vh;
  pointer-events: none;
  z-index: 1;
  background-image: 
    radial-gradient(60px 30px at 100px 50px, rgba(255,255,255,0.8), transparent),
    radial-gradient(80px 40px at 300px 100px, rgba(255,255,255,0.6), transparent),
    radial-gradient(50px 25px at 500px 80px, rgba(255,255,255,0.7), transparent),
    radial-gradient(70px 35px at 200px 150px, rgba(255,255,255,0.5), transparent);
  background-repeat: repeat;
  background-size: 600px 200px;
  animation: cloudDrift 20s linear infinite;
}
.theme-day::after {
  content: '';
  position: fixed;
  top: 50px; right: 50px;
  width: 100px; height: 100px;
  pointer-events: none;
  z-index: 1;
  background: radial-gradient(circle, #FFD700 30%, rgba(255,215,0,0.3) 70%, transparent);
  border-radius: 50%;
  animation: sunPulse 4s ease-in-out infinite;
  box-shadow: 0 0 50px rgba(255,215,0,0.5);
}

.theme-night { 
  background: linear-gradient(135deg, #0c0c0c 0%, #1a0033 50%, #000051 100%);
  --board-bg: #071229;
  position: relative;
}
.theme-night::before {
  content: '';
  position: fixed;
  top: 0; left: 0;
  width: 100vw; height: 100vh;
  pointer-events: none;
  z-index: 1;
  background-image: 
    radial-gradient(2px 2px at 50px 50px, #ffffff, transparent),
    radial-gradient(1px 1px at 150px 100px, rgba(255,255,255,0.8), transparent),
    radial-gradient(2px 2px at 300px 150px, #ffffff, transparent),
    radial-gradient(1px 1px at 450px 80px, rgba(255,255,255,0.9), transparent),
    radial-gradient(3px 3px at 200px 200px, #87CEEB, transparent);
  background-repeat: repeat;
  background-size: 500px 250px;
  animation: starfield 25s linear infinite;
}
.theme-night::after {
  content: '';
  position: fixed;
  top: 0; left: -10%; right: -10%; /* Extend beyond screen edges */
  height: 25vh; /* Only top quarter of screen */
  pointer-events: none;
  z-index: 1;
  background: linear-gradient(180deg, 
    rgba(0,255,150,0.3) 0%,
    rgba(150,0,255,0.4) 20%, 
    rgba(0,150,255,0.3) 40%, 
    rgba(255,20,147,0.2) 60%,
    rgba(0,255,150,0.1) 80%,
    transparent 100%),
    /* Add radial fade from sides */
    radial-gradient(ellipse 120% 100% at center top,
    rgba(255,255,255,0.1) 0%,
    transparent 70%);
  animation: aurora 30s ease-in-out infinite;
  opacity: 0.6;
}

.theme-cyberpunk { 
  background: linear-gradient(135deg, #0a0a0a 0%, #1a0033 20%, #ff006e 30%, #8338ec 60%, #06ffa5 90%, #003d82 100%);
  --board-bg: #0a0011;
  position: relative;
}
.theme-cyberpunk::before {
  content: '01001000 01100101 01101100 01101100 01101111 00100000 01010111 01101111 01110010 01101100 01100100 00001010 01010000 01111001 01110100 01101000 01101111 01101110 01101001 01111000 00001010 01000101 01101110 01110100 01100101 01110010 00100000 01110100 01101000 01100101 00100000 01001101 01100001 01110100 01110010 01101001 01111000';
  position: fixed;
  top: 0; left: 0;
  width: 100vw; height: 100vh;
  pointer-events: none;
  z-index: 1;
  color: rgba(6, 255, 165, 0.08);
  font-family: 'Courier New', monospace;
  font-size: 10px;
  line-height: 12px;
  animation: matrixRainFlow 20s linear infinite;
  word-wrap: break-word;
  overflow: hidden;
  white-space: pre-wrap;
}
.theme-cyberpunk::after {
  content: '';
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  pointer-events: none;
  z-index: 1;
  background: 
    repeating-linear-gradient(90deg, 
      transparent, 
      transparent 98px, 
      rgba(255, 0, 110, 0.03) 100px),
    repeating-linear-gradient(0deg,
      transparent,
      transparent 98px,
      rgba(6, 255, 165, 0.02) 100px),
    radial-gradient(circle at 25% 25%, rgba(131, 56, 236, 0.1), transparent 50%),
    radial-gradient(circle at 75% 75%, rgba(255, 0, 110, 0.1), transparent 50%);
  animation: cyberGlitch 15s linear infinite;
}

.theme-retro { 
  background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 50%, #ffd6a5 100%);
  --board-bg: #fff7e6;
  position: relative;
}
.theme-retro::before {
  content: '';
  position: fixed;
  top: 0; left: 0;
  width: 100vw; height: 100vh;
  pointer-events: none;
  z-index: 1;
  background: 
    conic-gradient(from 0deg at 100px 100px, #ff6b9d, #c44569, #f8b500, #ff6b9d),
    conic-gradient(from 45deg at 300px 200px, #4834d4, #686de0, #30336b, #4834d4),
    conic-gradient(from 90deg at 500px 150px, #ff9ff3, #f368e0, #ff3838, #ff9ff3);
  background-size: 200px 200px, 250px 250px, 180px 180px;
  opacity: 0.1;
  animation: retroSpin 20s linear infinite;
}
.theme-retro::after {
  content: '';
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  pointer-events: none;
  z-index: 1;
  background: 
    repeating-linear-gradient(0deg, 
      transparent, 
      transparent 3px, 
      rgba(0,0,0,0.05) 4px);
  animation: filmGrain 0.1s linear infinite;
}

.theme-halloween { 
  background: linear-gradient(135deg, #0a0a0a 0%, #2a1810 20%, #4a2c00 40%, #ff6f00 70%, #8b0000 100%);
  --board-bg: #2a1200;
  position: relative;
}
.theme-halloween::before {
  content: '';
  position: fixed;
  top: 0; left: 0;
  width: 100vw; height: 100vh;
  pointer-events: none;
  z-index: 1;
  background: 
    radial-gradient(circle at 20% 30%, rgba(255, 111, 0, 0.1), transparent 40%),
    radial-gradient(circle at 80% 70%, rgba(139, 0, 0, 0.15), transparent 35%),
    radial-gradient(circle at 50% 50%, rgba(128, 0, 128, 0.1), transparent 30%);
  animation: halloweenFloat 25s ease-in-out infinite;
}
.theme-halloween::after {
  content: '';
  position: fixed;
  top: 0; left: 0;
  width: 100vw; height: 100vh;
  pointer-events: none;
  z-index: 1;
  background: 
    radial-gradient(circle at 15% 25%, rgba(255, 111, 0, 0.3), transparent 35%),
    radial-gradient(circle at 85% 75%, rgba(139, 0, 0, 0.25), transparent 40%),
    radial-gradient(circle at 50% 10%, rgba(255, 215, 0, 0.15), transparent 30%),
    radial-gradient(circle at 70% 50%, rgba(128, 0, 128, 0.2), transparent 25%),
    radial-gradient(circle at 20% 80%, rgba(255, 20, 20, 0.2), transparent 30%);
  animation: spookyGlow 18s ease-in-out infinite;
}

.theme-christmas { 
  background: linear-gradient(135deg, #0f4c75 0%, #1e5a8a 20%, #3282b8 40%, #87ceeb 70%, #ffffff 100%);
  --board-bg: #f0fff0;
  position: relative;
}
.theme-christmas::before {
  content: '';
  position: fixed;
  top: -50px; left: 0; 
  width: 100vw; 
  height: calc(100vh + 100px);
  pointer-events: none;
  z-index: 1;
  background-image: 
    radial-gradient(2px 2px at 20px 30px, #ffffff, transparent),
    radial-gradient(3px 3px at 40px 70px, rgba(255,255,255,0.9), transparent),
    radial-gradient(1px 1px at 90px 40px, #ffffff, transparent),
    radial-gradient(2px 2px at 130px 80px, rgba(255,255,255,0.8), transparent),
    radial-gradient(2px 2px at 160px 30px, #ffffff, transparent),
    radial-gradient(1px 1px at 190px 90px, rgba(255,255,255,0.9), transparent),
    radial-gradient(3px 3px at 220px 10px, #ffffff, transparent),
    radial-gradient(2px 2px at 250px 50px, rgba(255,255,255,0.7), transparent),
    radial-gradient(1px 1px at 280px 90px, rgba(255,255,255,0.6), transparent),
    radial-gradient(2px 2px at 310px 40px, #ffffff, transparent);
  background-repeat: repeat;
  background-size: 350px 250px;
  animation: snowDriftSeamless 17s linear infinite;
}
.theme-christmas::after {
  content: '';
  position: fixed;
  top: -100px; left: 0;
  width: 100vw;
  height: calc(100vh + 200px);
  pointer-events: none;
  z-index: 2;
  background-image: 
    radial-gradient(1px 1px at 50px 160px, #ffffff, transparent),
    radial-gradient(2px 2px at 120px 120px, rgba(255,255,255,0.6), transparent),
    radial-gradient(1px 1px at 170px 150px, #ffffff, transparent),
    radial-gradient(3px 3px at 210px 60px, rgba(255,255,255,0.8), transparent),
    radial-gradient(1px 1px at 240px 180px, #ffffff, transparent),
    radial-gradient(2px 2px at 270px 20px, rgba(255,255,255,0.7), transparent),
    radial-gradient(1px 1px at 300px 200px, rgba(255,255,255,0.5), transparent),
    radial-gradient(2px 2px at 330px 100px, rgba(255,255,255,0.8), transparent);
  background-repeat: repeat;
  background-size: 400px 300px;
  animation: snowDriftSeamless2 23s linear infinite;
}

/* Third snow layer for continuous effect */
.theme-christmas body::before {
  content: '';
  position: fixed;
  top: -120px; left: 0;
  width: 100vw;
  height: calc(100vh + 240px);
  pointer-events: none;
  z-index: 0;
  background-image: 
    radial-gradient(1px 1px at 30px 80px, rgba(255,255,255,0.4), transparent),
    radial-gradient(2px 2px at 80px 180px, rgba(255,255,255,0.5), transparent),
    radial-gradient(1px 1px at 140px 40px, rgba(255,255,255,0.3), transparent),
    radial-gradient(3px 3px at 190px 140px, rgba(255,255,255,0.6), transparent),
    radial-gradient(1px 1px at 260px 70px, rgba(255,255,255,0.4), transparent),
    radial-gradient(2px 2px at 320px 160px, rgba(255,255,255,0.5), transparent);
  background-repeat: repeat;
  background-size: 380px 280px;
  animation: snowDriftSeamless3 29s linear infinite;
}

/* Additional snow layers for seamless effect */
.theme-christmas .navbar::before {
  content: '';
  position: fixed;
  top: -160px; left: 0;
  width: 100vw;
  height: calc(100vh + 320px);
  pointer-events: none;
  z-index: -1;
  background-image: 
    radial-gradient(1px 1px at 40px 100px, rgba(255,255,255,0.3), transparent),
    radial-gradient(2px 2px at 110px 60px, rgba(255,255,255,0.4), transparent),
    radial-gradient(1px 1px at 180px 140px, rgba(255,255,255,0.2), transparent),
    radial-gradient(2px 2px at 250px 20px, rgba(255,255,255,0.5), transparent),
    radial-gradient(1px 1px at 310px 180px, rgba(255,255,255,0.3), transparent);
  background-repeat: repeat;
  background-size: 360px 220px;
  animation: snowDriftSeamless4 31s linear infinite;
}

.theme-christmas #gameCanvas::before {
  content: '';
  position: fixed;
  top: -200px; left: 0;
  width: 100vw;
  height: calc(100vh + 400px);
  pointer-events: none;
  z-index: -2;
  background-image: 
    radial-gradient(1px 1px at 25px 70px, rgba(255,255,255,0.2), transparent),
    radial-gradient(1px 1px at 95px 170px, rgba(255,255,255,0.3), transparent),
    radial-gradient(2px 2px at 165px 30px, rgba(255,255,255,0.4), transparent),
    radial-gradient(1px 1px at 235px 130px, rgba(255,255,255,0.2), transparent),
    radial-gradient(2px 2px at 305px 90px, rgba(255,255,255,0.3), transparent);
  background-repeat: repeat;
  background-size: 340px 200px;
  animation: snowDriftSeamless5 37s linear infinite;
}

.theme-easter { 
  background: linear-gradient(135deg, #fff1f3 0%, #ffeef0 20%, #ffd1dc 50%, #ffe4e1 75%, #fffaf0 100%);
  --board-bg: #fff7f5;
  position: relative;
}
.theme-easter::before {
  content: '';
  position: fixed;
  top: -50px; left: 0;
  width: 100vw; height: calc(100vh + 100px);
  pointer-events: none;
  z-index: 1;
  background-image: 
    radial-gradient(3px 3px at 80px 50px, #FFB6C1, transparent),
    radial-gradient(2px 2px at 180px 100px, #FFC0CB, transparent),
    radial-gradient(4px 4px at 280px 150px, #FFCCCB, transparent),
    radial-gradient(2px 2px at 380px 80px, #F0E68C, transparent),
    radial-gradient(3px 3px at 120px 180px, #DDA0DD, transparent),
    radial-gradient(2px 2px at 320px 200px, #F5DEB3, transparent),
    radial-gradient(4px 4px at 220px 250px, #FFA07A, transparent),
    radial-gradient(3px 3px at 420px 180px, #98FB98, transparent);
  background-repeat: repeat;
  background-size: 500px 400px;
  animation: springPetalFall 20s ease-in-out infinite;
}
.theme-easter::after {
  content: '';
  position: fixed;
  top: 20%; left: 10%;
  width: 80vw; height: 60vh;
  pointer-events: none;
  z-index: 1;
  background: 
    radial-gradient(circle at 30% 40%, rgba(255, 182, 193, 0.2), transparent 40%),
    radial-gradient(circle at 70% 60%, rgba(221, 160, 221, 0.15), transparent 35%);
  animation: springDance 15s ease-in-out infinite;
  filter: blur(1px);
}

    /* Simple, gentle animations for special effects only */
    @keyframes gentleStars {
      0%, 100% { opacity: 0.1; }
      50% { opacity: 0.3; }
    }
    @keyframes spookyFloat {
      0% { transform: translateY(100vh) translateX(0%); }
      100% { transform: translateY(-10vh) translateX(100%); }
    }
    @keyframes snowDrift {
      0% { transform: translateY(-10px) translateX(0px); }
      100% { transform: translateY(100vh) translateX(100px); }
    }
    
    /* New seamless snow animation for Christmas */
    @keyframes snowDriftSeamless {
      0% { transform: translateY(-120px) translateX(-15px); opacity: 0; }
      3% { opacity: 1; }
      97% { opacity: 1; }
      100% { transform: translateY(calc(100vh + 120px)) translateX(35px); opacity: 0; }
    }
    
    @keyframes snowDriftSeamless2 {
      0% { transform: translateY(-180px) translateX(25px); opacity: 0; }
      7% { opacity: 0.8; }
      93% { opacity: 0.8; }
      100% { transform: translateY(calc(100vh + 180px)) translateX(-30px); opacity: 0; }
    }
    
    @keyframes snowDriftSeamless3 {
      0% { transform: translateY(-90px) translateX(-35px); opacity: 0; }
      2% { opacity: 0.6; }
      98% { opacity: 0.6; }
      100% { transform: translateY(calc(100vh + 90px)) translateX(45px); opacity: 0; }
    }

    @keyframes snowDriftSeamless4 {
      0% { transform: translateY(-150px) translateX(10px); opacity: 0; }
      5% { opacity: 0.7; }
      95% { opacity: 0.7; }
      100% { transform: translateY(calc(100vh + 150px)) translateX(-20px); opacity: 0; }
    }

    @keyframes snowDriftSeamless5 {
      0% { transform: translateY(-200px) translateX(-5px); opacity: 0; }
      8% { opacity: 0.5; }
      92% { opacity: 0.5; }
      100% { transform: translateY(calc(100vh + 200px)) translateX(55px); opacity: 0; }
    }
    
    /* Improved Halloween animations */
    @keyframes halloweenFloat {
      0% { transform: translateY(100vh) translateX(-50px) rotate(0deg); opacity: 0; }
      10% { opacity: 0.15; }
      90% { opacity: 0.15; }
      100% { transform: translateY(-20vh) translateX(100vw) rotate(20deg); opacity: 0; }
    }
    
    /* Enhanced Cyberpunk animations */
    @keyframes matrixRainFlow {
      0% { transform: translateY(-100vh) translateX(-20px); opacity: 0; }
      10% { opacity: 0.8; }
      90% { opacity: 0.8; }
      100% { transform: translateY(100vh) translateX(20px); opacity: 0; }
    }
    
    /* Enhanced Easter animations */
    @keyframes springPetalFall {
      0% { transform: translateY(-50px) translateX(0) rotate(0deg); opacity: 0.8; }
      100% { transform: translateY(calc(100vh + 50px)) translateX(30px) rotate(180deg); opacity: 0.3; }
    }
    
    @keyframes springDance {
      0% { transform: translate(0, 0) rotate(0deg) scale(1); }
      25% { transform: translate(20px, -10px) rotate(5deg) scale(1.05); }
      50% { transform: translate(40px, 0) rotate(-3deg) scale(0.95); }
      75% { transform: translate(20px, 10px) rotate(8deg) scale(1.1); }
      100% { transform: translate(0, 0) rotate(0deg) scale(1); }
    }
    
    /* Enhanced St. Patrick's animations */
    @keyframes rainbowFlow {
      0% { transform: translateX(-100px) scaleY(1); opacity: 0.6; }
      50% { transform: translateX(100px) scaleY(1.2); opacity: 0.8; }
      100% { transform: translateX(-100px) scaleY(1); opacity: 0.6; }
    }
    
    @keyframes springBounce {
      0%, 100% { transform: translateY(0) scale(1); }
      50% { transform: translateY(-5px) scale(1.02); }
    }
    @keyframes luckySpin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    @keyframes fallLeaves {
      0% { transform: translateY(-10vh) rotate(0deg); }
      100% { transform: translateY(100vh) rotate(180deg); }
    }

    /* Amazing new 3D theme animations */
    @keyframes cloudDrift {
      0% { transform: translateX(-200px); }
      100% { transform: translateX(100vw); }
    }
    @keyframes sunPulse {
      0%, 100% { transform: scale(1) rotate(0deg); box-shadow: 0 0 50px rgba(255,215,0,0.5); }
      50% { transform: scale(1.1) rotate(180deg); box-shadow: 0 0 80px rgba(255,215,0,0.8); }
    }
    @keyframes starfield {
      0% { transform: translateY(0px) translateX(0px); opacity: 0.8; }
      100% { transform: translateY(-50px) translateX(50px); opacity: 1; }
    }
    @keyframes aurora {
      0% { 
        opacity: 0.4; 
        filter: blur(1px);
        transform: scaleY(1) translateY(0px);
      }
      20% { 
        opacity: 0.6; 
        filter: blur(1.5px);
        transform: scaleY(1.05) translateY(-2px);
      }
      40% { 
        opacity: 0.7; 
        filter: blur(2px);
        transform: scaleY(0.95) translateY(-1px);
      }
      60% { 
        opacity: 0.5; 
        filter: blur(1.5px);
        transform: scaleY(1.1) translateY(-3px);
      }
      80% { 
        opacity: 0.6; 
        filter: blur(1px);
        transform: scaleY(0.98) translateY(-1px);
      }
      100% { 
        opacity: 0.4; 
        filter: blur(1px);
        transform: scaleY(1) translateY(0px);
      }
    }
    @keyframes matrixRain {
      0% { transform: translateY(-100vh); opacity: 0; }
      10% { opacity: 1; }
      90% { opacity: 1; }
      100% { transform: translateY(100vh); opacity: 0; }
    }
    @keyframes cyberGlitch {
      0%, 90%, 100% { opacity: 0.05; }
      5%, 85% { opacity: 0.15; transform: skew(0.5deg); }
      10%, 80% { opacity: 0.1; transform: skew(-0.3deg); }
    }
    @keyframes retroSpin {
      0% { transform: rotate(0deg) scale(1); }
      50% { transform: rotate(180deg) scale(1.1); }
      100% { transform: rotate(360deg) scale(1); }
    }
    @keyframes filmGrain {
      0% { opacity: 0.03; }
      50% { opacity: 0.06; }
      100% { opacity: 0.03; }
    }
    @keyframes plasmaPulse {
      0%, 100% { transform: scale(1) rotate(0deg); opacity: 0.6; }
      20% { transform: scale(1.1) rotate(72deg); opacity: 0.8; }
      40% { transform: scale(0.9) rotate(144deg); opacity: 0.5; }
      60% { transform: scale(1.2) rotate(216deg); opacity: 0.9; }
      80% { transform: scale(0.95) rotate(288deg); opacity: 0.4; }
    }
    @keyframes circuitFlow {
      0% { background-position: 0 0, 0 0, 0 0, 0 0; opacity: 0.3; }
      25% { background-position: 25px 25px, -25px 25px, 25px -25px, -25px -25px; opacity: 0.6; }
      50% { background-position: 50px 50px, -50px 50px, 50px -50px, -50px -50px; opacity: 0.4; }
      75% { background-position: 75px 75px, -75px 75px, 75px -75px, -75px -75px; opacity: 0.7; }
      100% { background-position: 100px 100px, -100px 100px, 100px -100px, -100px -100px; opacity: 0.3; }
    }
    @keyframes ghostFloat {
      0% { transform: translateY(100vh) translateX(0) rotate(0deg); opacity: 0; }
      10% { opacity: 0.6; }
      90% { opacity: 0.3; }
      100% { transform: translateY(-20vh) translateX(80vw) rotate(20deg); opacity: 0; }
    }
    @keyframes spookyGlow {
      0%, 100% { opacity: 0.4; transform: scale(1); }
      25% { opacity: 0.7; transform: scale(1.1); }
      75% { opacity: 0.2; transform: scale(0.9); }
    }
    @keyframes petalFall {
      0% { transform: translateY(-20px) translateX(0) rotate(0deg); }
      100% { transform: translateY(120vh) translateX(50px) rotate(360deg); }
    }
    @keyframes butterflyFly {
      0% { transform: translate(0, 0) rotate(0deg); }
      25% { transform: translate(100px, -50px) rotate(10deg); }
      50% { transform: translate(200px, 0) rotate(-5deg); }
      75% { transform: translate(150px, 50px) rotate(15deg); }
      100% { transform: translate(0, 0) rotate(0deg); }
    }
    @keyframes rainbow {
      0% { transform: translateX(-100px) rotate(-10deg); }
      50% { transform: translateX(100px) rotate(10deg); }
      100% { transform: translateX(-100px) rotate(-10deg); }
    }
    @keyframes cloverSpin {
      0% { transform: translateY(-10px) rotate(0deg) scale(1); opacity: 0.2; }
      50% { transform: translateY(10px) rotate(180deg) scale(1.2); opacity: 0.4; }
      100% { transform: translateY(-10px) rotate(360deg) scale(1); opacity: 0.2; }
    }
    @keyframes gentleLeafFall {
      0% { transform: translateY(-20px) translateX(0) rotate(0deg); opacity: 0.7; }
      50% { transform: translateY(60vh) translateX(-20px) rotate(180deg); opacity: 0.9; }
      100% { transform: translateY(120vh) translateX(30px) rotate(360deg); opacity: 0.5; }
    }
    @keyframes gentleBounce {
      0%, 100% { transform: translateY(0) rotate(-1deg) scale(1); }
      50% { transform: translateY(-3px) rotate(1deg) scale(1.02); }
    }

    /* subtle improvement for canvas to match theme */
    #gameCanvas { 
      border-radius:12px; 
      border-width:3px; 
      box-shadow: 0 18px 60px rgba(0,0,0,0.3);
      position: relative;
      z-index: 2;
    }

    html, body {
      min-height: 100vh;
      margin: 0;
      font-family: 'Press Start 2P', 'Segoe UI', Arial, sans-serif;
      background: var(--bg, linear-gradient(135deg, #66b5ff 0%, #3863ff 100%));
      transition: background 0.4s;
      margin: 0;
      font-size: 1rem;
      color: #222;
      font-weight: 600;
      /* mimic current.com logo style */
      cursor: default;
    }

    /* REMOVED DUPLICATE NAVBAR STYLES */

    .navbar-controls {
      display: flex;
      gap: 20px;
      align-items: center;
    }
    .navbar-controls label {
      display: flex;
      align-items: center;
      gap: 8px;
      color: #e0e0e0;
      font-weight: 700;
      font-size: 0.9rem;
      text-shadow: none;
    }

    .navbar input, .navbar select {
      padding: 6px 10px;
      font-size: 0.9rem;
      border-radius: 6px;
      border: 1px solid rgba(255,255,255,0.3);
      background: rgba(255,255,255,0.1);
      color: #ffffff;
      font-weight: 600;
      text-shadow: none;
      min-width: 0;
      max-width: 120px;
    }

    .navbar input[type="text"] {
      max-width: 120px;
    }

    .navbar input[type="color"] {
      /* Revert to default sizing to avoid clipping */
  /* fixed size color picker */
  width: 32px !important;
  height: 32px !important;
  padding: 0 !important;
  border-radius: 50% !important;
  border: none !important;
  background: none !important;
  min-width: 32px !important;
  max-width: 32px !important;
    }

    .navbar .emoji-picker {
      font-size: 1.2em;
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 4px 6px;
      cursor: pointer;
      transition: background 0.2s;
    }

    .navbar .emoji-picker:hover {
      background: #f5f5f5;
    }

    .container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      width: 100%;
      box-sizing: border-box;
      padding: 20px;
    }

    .card {
      background: rgba(255, 255, 255, 0.85);
      padding: 30px 40px;
      border-radius: 20px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.2);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 15px;
      max-width: 95vw; 
      box-sizing: border-box;
    }

    h1 {
      margin-bottom: 10px;
      color: var(--menu, #222);
      letter-spacing: 2px;
      text-shadow: 0 2px 8px #acb6e5;
      font-family: 'Press Start 2P', 'Segoe UI', Arial, sans-serif;
      font-size: 2em;
    }

    .touch-btn {
      width: 48px;
      .navbar-controls {
        /* absolutely place beneath title, hidden by default */
        position: absolute;
        top: 100%;
        left: 50%;
        transform: translateX(-50%);
        opacity: 0;
        max-height: 0;
        margin-top: 0;
        pointer-events: none;
        overflow: hidden;
        transition: opacity 0.3s ease, max-height 0.3s ease, margin-top 0.3s ease;
      }
      box-shadow: 0 2px 8px #acb6e5;
      cursor: pointer;
      .navbar:hover .navbar-controls {
        opacity: 1;
        max-height: 200px;
        margin-top: 10px;
        pointer-events: auto;
      }
      transform: scale(0.95);
    }

    #gameCanvas {
      background: #f7fffe;
      box-shadow: 0 8px 32px 0 rgba(44,62,80,0.2);
      border: 4px solid #6c7a89;
      display: block;
      margin: 0 auto;
      touch-action: none;
      transition: background 0.4s;
      max-width: 100%;
      height: auto;
    }

    .score-board {
      font-size: 1.5em;
      color: var(--menu, #222);
      font-weight: bold;
      letter-spacing: 1px;
      padding: 8px 24px;
      background: rgba(255,255,255,0.7);
      border-radius: 18px;
      box-shadow: 0 2px 8px #acb6e5;
      transition: color 0.4s;
    }

    .game-over {
      position: fixed;
      top: 0; left: 0; width: 100vw; height: 100vh;
      background: rgba(44,62,80,0.78);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 999;
      color: #fff;
      font-size: 2em;
      border-radius: 0;
      animation: fadeIn 0.5s;
    }

    .game-over button {
      margin-top: 24px;
      padding: 12px 32px;
      font-size: 1em;
      border: none;
      border-radius: 18px;
  background: linear-gradient(135deg, #4f8edc 0%, #27c5ff 100%);
      color: #222;
      font-weight: bold;
      box-shadow: 0 2px 8px #acb6e5;
      cursor: pointer;
      transition: background 0.2s;
    }

    .game-over button:hover {
      border-radius: 18px;
  background: linear-gradient(135deg, #4f8edc 0%, #27c5ff 100%);
      color: #222;
      font-weight: bold;
      box-shadow: 0 2px 8px #acb6e5;
      cursor: pointer;
      transition: background 0.2s;
    }

    .game-over button:hover {
  background: linear-gradient(135deg, #4f8edc 0%,#27c5ff  100%);
    }

    @keyframes fadeIn {
      0% { opacity: 0; }
      100% { opacity: 1; }
    }

    @media (max-width: 700px) {
      .navbar {
        padding: 6px 12px;
        font-size: 0.6em;
      }
      .navbar-brand h2 {
        font-size: 1em;
      }
      .navbar-controls {
        gap: 16px;
        flex-direction: column;
        align-items: stretch;
      }
      .control-group {
        width: 100%;
      }
      .control-row,
      .stats-row,
      .action-buttons {
        justify-content: center;
        gap: 8px;
      }
      .navbar-controls label {
        font-size: 0.8em;
          background: #ffffff;
          border-radius: 12px;
          box-shadow: 0 2px 8px rgba(0,0,0,0.1);
          padding: 8px 16px;
          min-width: 240px;  /* wider than title */
          opacity: 0;
          max-height: 0;
          margin: 0;
          pointer-events: none;
          overflow: hidden;
          transition: opacity 0.3s ease, max-height 0.3s ease, margin-top 0.3s ease;
        min-height: 180px;
      }
      .card {
        padding: 20px;
        border-radius: 15px;
      }
      .game-over {
        font-size: 1.2em;
        border-radius: 0;
        padding: 0;
      }
    }

    /* Intro screen overlay */
    .intro-screen {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.85);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: #fff;
      z-index: 1000;
    }
    .intro-screen h1 {
      font-size: 2em;
      margin-bottom: 1em;
    }
    .intro-screen button {
      padding: 12px 24px;
      font-size: 1em;
      border: none;
      border-radius: 18px;
      background: linear-gradient(135deg, #4f8edc 0%, #27c5ff 100%);
      color: #222;
      cursor: pointer;
      box-shadow: 0 2px 8px #acb6e5;
      transition: background 0.2s;
    }
    .intro-screen button:hover {
      background: linear-gradient(135deg, #4f8edc 0%, #27c5ff 100%);
    }
        @media (max-width: 480px) {
          .card { padding: 15px; }
          .score-board, .score-board ~ .score-board { font-size: 1em; padding: 6px 12px; }
        }

    /* Modal / panel styles for history & achievements */
    .panel-modal {
      position: fixed; inset: 0; display: none; align-items: center; justify-content: center;
      background: rgba(0,0,0,0.6); z-index: 2000;
    }
    .panel-modal .panel {
      background: #fff; color:#222; padding:18px; border-radius:12px; width:90%; max-width:720px; max-height:80vh; overflow:auto;
    }
    .theme-badge { display:inline-block; padding:6px 10px; border-radius:10px; margin:6px; cursor:pointer; box-shadow:0 2px 8px rgba(0,0,0,0.12); }
    .small-btn { padding:6px 10px; border-radius:8px; cursor:pointer; border:none; background:#e6e6e6; margin-left:6px; }
    /* obstacle tile */
    .obstacle { background:#333; }

.achievements-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  gap: 15px;
  margin-top: 20px;
}

.achievement {
  display: flex;
  align-items: center;
  padding: 15px;
  border-radius: 10px;
  background: rgba(255,255,255,0.05);
  border: 1px solid rgba(255,255,255,0.1);
}

.achievement.unlocked {
  background: rgba(76, 175, 80, 0.2);
  border-color: rgba(76, 175, 80, 0.3);
}

.achievement.locked {
  opacity: 0.6;
}

.achievement-icon {
  font-size: 2rem;
  margin-right: 15px;
}

.achievement-info h4 {
  margin: 0 0 5px 0;
  color: #fff;
}

.achievement-info p {
  margin: 0;
  color: #ccc;
  font-size: 0.9rem;
}

.stats-overview {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 15px;
  margin: 20px 0;
}

.stat-item {
  padding: 15px;
  background: rgba(255,255,255,0.05);
  border-radius: 8px;
  text-align: center;
  color: #fff;
}

.history-list {
  max-height: 400px;
  overflow-y: auto;
}

.history-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 10px 15px;
  margin: 10px 0;
  background: rgba(255,255,255,0.03);
  border-radius: 8px;
  border-left: 4px solid #4CAF50;
}

.game-info {
  display: flex;
  gap: 20px;
}

.game-score {
  font-weight: bold;
  color: #4CAF50;
}

.game-foods {
  color: #2196F3;
}

.game-mode {
  color: #FF9800;
}

.game-date {
  color: #ccc;
  font-size: 0.9rem;
}

/* Make navbar stat items (High Score, Foods Eaten) dark and readable */
.navbar .stat-item {
  padding: 6px 12px !important;
  background: rgba(255,255,255,0.1) !important;
  border-radius: 8px;
  text-align: center;
  color: #ffffff !important;
  font-weight: 700;
  font-size: 0.85rem;
  border: 1px solid rgba(255,255,255,0.15);
  text-shadow: none;
}

/* Also make the multiplier display dark */
#multiplierNav {
  background: rgba(255,215,0,0.2) !important;
  color: #ffffff !important;
  font-weight: 700;
}

/* Style for clear games button */
.clear-btn {
  background: rgba(220, 53, 69, 0.9) !important;
  color: #ffffff !important;
  border: 1px solid rgba(220, 53, 69, 0.8) !important;
}
.clear-btn:hover {
  background: rgba(220, 53, 69, 1) !important;
  transform: translateY(-1px);
}

  </style>
</head>
<body class="theme-day">
  <!-- Intro Screen -->
  <div id="introScreen" class="intro-screen">
    <h1>🐍 Pythonix</h1>
    <button id="startBtn">Start Game</button>
  </div>
  <div class="navbar">
    <div class="navbar-brand">
      <h2>🐍 Pythonix</h2>
    </div>
    <div class="navbar-controls">
      <!-- Player Settings Group -->
      <div class="control-group">
        <div class="group-title">Player</div>
        <div class="control-row">
          <label>Name:
            <input type="text" id="playerName" placeholder="Enter name" maxlength="20">
          </label>
        </div>
      </div>

      <!-- Snake Customization Group -->
      <div class="control-group">
        <div class="group-title">Snake Style</div>
        <div class="control-row">
          <label>Shape:
            <select id="snakeShape">
              <option value="square">Square</option>
              <option value="emoji">Emoji</option>
            </select>
          </label>
          <span id="emojiPickerContainer" style="display:none;">
            <label>Emoji:
              <input type="text" id="emojiPicker" value="🐍" maxlength="4" placeholder="🐍" title="Type or paste any emoji here!">
            </label>
          </span>
          <label>Skin:
            <select id="snakeSkin">
              <option value="green">Green (Classic)</option>
              <option value="blueGradient">Blue Gradient</option>
              <option value="retroGradient">Retro Gradient</option>
              <option value="rainbow">Rainbow (animated)</option>
            </select>
          </label>
        </div>
      </div>

      <!-- Game Settings Group -->
      <div class="control-group">
        <div class="group-title">Game Settings</div>
        <div class="control-row">
          <label>Mode:
            <select id="gameMode">
              <option value="classic">Classic</option>
              <option value="time">Time Attack</option>
              <option value="hard">Hard Mode</option>
            </select>
          </label>
          <label>Theme:
            <select id="themeSelect">
              <option value="auto">Day/Night (Auto)</option>
              <option value="day">Day</option>
              <option value="night">Night</option>
              <option value="cyberpunk">Cyberpunk</option>
              <option value="retro">Retro</option>
              <option value="halloween">Halloween</option>
              <option value="christmas">Christmas</option>
              <option value="easter">Easter</option>
            </select>
          </label>
          <label>Volume:
            <input type="range" id="volumeSlider" min="0" max="100" value="50">
            <span id="volumeValue">50%</span>
          </label>
        </div>
      </div>

      <!-- Stats and Actions Group -->
      <div class="control-group">
        <div class="group-title">Stats & Actions</div>
        <div class="stats-row">
          <span class="stat-item" id="highScoreNav">High Score: 0</span>
          <span class="stat-item" id="foodsEatenNav">Foods Eaten: 0</span>
          <span class="stat-item" id="multiplierNav" style="display:none;">x2 (0s)</span>
          <label id="timeAttackDisplay" style="display:none;">Time:
            <span id="timeLeft">--</span>s
          </label>
        </div>
        <div class="action-buttons">
          <button id="showHistory" class="small-btn">History</button>
          <button id="showAchievements" class="small-btn">Achievements</button>
          <button id="clearGames" class="small-btn clear-btn">Clear Games</button>
        </div>
      </div>
    </div>
  </div>
  <div class="container">
    <div class="card">
      <h1>Pythonix</h1>
      <div class="score-board" id="scoreBoard">Score: 0</div>
      <div style="position:relative;">
  <canvas id="gameCanvas" width="480" height="480"></canvas>
        <div id="gameOverScreen" class="game-over" style="display:none;">
          <span id="gameOverText"></span>
          <button onclick="restartGame()">Restart</button>
        </div>
      </div>
      <div style="margin-top:18px;">
        <span style="color:#444;font-size:1em;">
          Use <b>WASD</b>, <b>arrow keys</b>, <b>swipe</b>, or <b>touch controls</b> to play
        </span>
      </div>
    </div>
  </div>
  <!-- Achievements Modal -->
<div id="achievementsModal" class="modal" style="display: none;">
  <div class="modal-content">
    <span class="close" onclick="document.getElementById('achievementsModal').style.display='none'">&times;</span>
    <h2>🏆 Achievements</h2>
    <div id="achievementsContent">Loading achievements...</div>
  </div>
</div>

<!-- Game History Modal -->
<div id="historyModal" class="modal" style="display: none;">
  <div class="modal-content">
    <span class="close" onclick="document.getElementById('historyModal').style.display='none'">&times;</span>
    <h2>📈 Game History</h2>
    <div id="historyContent">Loading history...</div>
  </div>
</div>

<!-- Add modal CSS -->
<style>
.modal {
  position: fixed;
  z-index: 1000;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0,0,0,0.8);
  display: flex;
  align-items: center;
  justify-content: center;
}

.modal-content {
  background: linear-gradient(135deg, #1a1a2e, #16213e);
  margin: auto;
  padding: 30px;
  border-radius: 15px;
  width: 80%;
  max-width: 800px;
  max-height: 80vh;
  overflow-y: auto;
  color: #fff;
  box-shadow: 0 20px 60px rgba(0,0,0,0.5);
}

.close {
  color: #aaa;
  float: right;
  font-size: 28px;
  font-weight: bold;
  cursor: pointer;
  line-height: 1;
}

.close:hover {
  color: #fff;
}

.achievements-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  gap: 15px;
  margin-top: 20px;
}

.achievement {
  display: flex;
  align-items: center;
  padding: 15px;
  border-radius: 10px;
  background: rgba(255,255,255,0.05);
  border: 1px solid rgba(255,255,255,0.1);
}

.achievement.unlocked {
  background: rgba(76, 175, 80, 0.2);
  border-color: rgba(76, 175, 80, 0.3);
}

.achievement.locked {
  opacity: 0.6;
}

.achievement-icon {
  font-size: 2rem;
  margin-right: 15px;
}

.achievement-info h4 {
  margin: 0 0 5px 0;
  color: #fff;
}

.achievement-info p {
  margin: 0;
  color: #ccc;
  font-size: 0.9rem;
}

.stats-overview {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 15px;
  margin: 20px 0;
}

.stat-item {
  padding: 15px;
  background: rgba(255,255,255,0.05);
  border-radius: 8px;
  text-align: center;
  color: #fff;
}

.history-list {
  max-height: 400px;
  overflow-y: auto;
}

.history-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 10px 15px;
  margin: 10px 0;
  background: rgba(255,255,255,0.03);
  border-radius: 8px;
  border-left: 4px solid #4CAF50;
}

.game-info {
  display: flex;
  gap: 20px;
}

.game-score {
  font-weight: bold;
  color: #4CAF50;
}

.game-foods {
  color: #2196F3;
}

.game-mode {
  color: #FF9800;
}

.game-date {
  color: #ccc;
  font-size: 0.9rem;
}
</style>

<script>
// Global game variables
let canvas, ctx, boxSize = 40, boardWidth, boardHeight;
let snake, direction, food, score = 0, foodsEaten = 0;
let gameInterval, isGameOver = false;
let speed = 150, baseSpeed = 150;
let obstacles = [];
let gameMode = 'classic';
let snakeShape = 'square';
let snakeEmoji = '🐍';
let snakeSkin = 'green';
let multiplierActive = false;
let multiplierInterval, speedInterval, multiplierExpireTime;
let gameTimeLeft = 60, gameTimeInterval;
let multiplierTimeLeft = 0, speedTimeLeft = 0;

// Sound effects
const eatSound = new Audio('eat.mp3');
eatSound.volume = 0.5;
const powerSound = new Audio('powerup.mp3');
powerSound.volume = 0.5;
const gameOverSound = new Audio('gameover.mp3');
gameOverSound.volume = 0.5;

// Volume control functionality
function updateVolume(value) {
  const volume = value / 100;
  eatSound.volume = volume;
  powerSound.volume = volume;
  gameOverSound.volume = volume;
  
  // Update game.js sounds if available
  if (window.updateGameJsVolume) {
    window.updateGameJsVolume(volume);
  }
  
  document.getElementById('volumeValue').textContent = value + '%';
  localStorage.setItem('pythonixVolume', value);
}

// Initialize volume from localStorage or default to 50%
const savedVolume = localStorage.getItem('pythonixVolume') || 50;
document.addEventListener('DOMContentLoaded', function() {
  const volumeSlider = document.getElementById('volumeSlider');
  volumeSlider.value = savedVolume;
  updateVolume(savedVolume);
  
  volumeSlider.addEventListener('input', function() {
    updateVolume(this.value);
  });
});

// Initialize canvas and board dimensions
function resizeCanvas() {
  canvas = document.getElementById('gameCanvas');
  if (!canvas) return;
  
  ctx = canvas.getContext('2d');
  // Make board square - 600x600 pixels
  canvas.width = 600;
  canvas.height = 600;
  boardWidth = canvas.width / boxSize;
  boardHeight = canvas.height / boxSize;
}

// Generate random food
function randomFood() {
  let pos;
  do {
    pos = {
      x: Math.floor(Math.random() * boardWidth),
      y: Math.floor(Math.random() * boardHeight),
      type: 'normal'
    };
  } while (snake && snake.some(s => s.x === pos.x && s.y === pos.y));
  
  // Random food types
  const rand = Math.random();
  if (rand < 0.05) pos.type = 'power_double';
  else if (rand < 0.1) pos.type = 'power_speed';
  
  return pos;
}

// Check if direction change is valid (no 180 degree turns)
function isValidDirection(newDirection, currentDirection) {
  const opposites = {
    'UP': 'DOWN',
    'DOWN': 'UP', 
    'LEFT': 'RIGHT',
    'RIGHT': 'LEFT'
  };
  return opposites[currentDirection] !== newDirection;
}

// Add the actual working functions for achievements and history
function showAchievements() {
  console.log('Loading achievements...');
  const modal = document.getElementById('achievementsModal');
  if (modal) {
    modal.style.display = 'flex';
    loadAchievements();
  } else {
    console.error('Achievements modal not found');
  }
}

function showGameHistory() {
  console.log('Loading game history...');
  const modal = document.getElementById('historyModal');
  if (modal) {
    modal.style.display = 'flex';
    loadGameHistory();
  } else {
    console.error('History modal not found');
  }
}

function clearAllGameData() {
  const confirmed = confirm('⚠️ This will permanently delete ALL your game data including:\\n\\n• High Score\\n• Game History\\n• Statistics\\n• Achievement Progress\\n\\nThis action cannot be undone! Are you sure?');
  
  if (confirmed) {
    const doubleConfirm = confirm('🚨 FINAL WARNING! 🚨\\n\\nYou will lose EVERYTHING:\\n• Your high score of ' + (localStorage.getItem('pythonixHighScore') || '0') + ' points\\n• All game statistics\\n• All unlocked achievements\\n\\nType YES in the next prompt to confirm deletion.');
    
    if (doubleConfirm) {
      const finalConfirm = prompt('Type "DELETE ALL DATA" to confirm (case sensitive):');
      
      if (finalConfirm === 'DELETE ALL DATA') {
        // Clear all game data
        localStorage.removeItem('pythonixHighScore');
        localStorage.removeItem('pythonixStats');
        localStorage.removeItem('pythonixGameHistory');
        localStorage.removeItem('pythonixAchievements');
        localStorage.removeItem('pythonixRuns');
        
        alert('✅ All game data has been deleted. The page will refresh.');
        window.location.reload();
      } else {
        alert('❌ Deletion cancelled - incorrect confirmation text.');
      }
    } else {
      alert('❌ Deletion cancelled by user.');
    }
  }
}

function loadAchievements() {
  const achievementsContent = document.getElementById('achievementsContent');
  if (!achievementsContent) {
    console.error('Achievements content element not found');
    return;
  }
  
  // Get current stats
  const highScore = parseInt(localStorage.getItem('pythonixHighScore') || '0');
  const stats = JSON.parse(localStorage.getItem('pythonixStats') || '{"gamesPlayed": 0, "totalFoodsEaten": 0}');
  
  console.log('Current stats:', stats, 'High score:', highScore);
  
  const achievements = [
    // Beginner achievements
    { id: 'first_game', name: 'First Steps', description: 'Play your first game', unlocked: stats.gamesPlayed >= 1, icon: '👶' },
    { id: 'score_50', name: 'Getting Started', description: 'Score 50 points', unlocked: highScore >= 50, icon: '🌱' },
    { id: 'score_100', name: 'Century Club', description: 'Score 100 points', unlocked: highScore >= 100, icon: '💯' },
    
    // Intermediate achievements  
    { id: 'score_250', name: 'Quarter Master', description: 'Score 250 points', unlocked: highScore >= 250, icon: '🎯' },
    { id: 'score_500', name: 'High Roller', description: 'Score 500 points', unlocked: highScore >= 500, icon: '🎰' },
    { id: 'games_5', name: 'Persistent', description: 'Play 5 games', unlocked: stats.gamesPlayed >= 5, icon: '🔥' },
    { id: 'games_10', name: 'Dedicated', description: 'Play 10 games', unlocked: stats.gamesPlayed >= 10, icon: '💪' },
    { id: 'foods_100', name: 'Hungry Snake', description: 'Eat 100 total foods', unlocked: stats.totalFoodsEaten >= 100, icon: '🍎' },
    
    // Hard achievements
    { id: 'score_1000', name: 'Millennium', description: 'Score 1,000 points', unlocked: highScore >= 1000, icon: '🚀' },
    { id: 'score_2500', name: 'Elite Player', description: 'Score 2,500 points', unlocked: highScore >= 2500, icon: '👑' },
    { id: 'score_5000', name: 'Snake Master', description: 'Score 5,000 points', unlocked: highScore >= 5000, icon: '🐍' },
    { id: 'games_25', name: 'Addicted', description: 'Play 25 games', unlocked: stats.gamesPlayed >= 25, icon: '🎮' },
    { id: 'games_50', name: 'No Life', description: 'Play 50 games', unlocked: stats.gamesPlayed >= 50, icon: '😅' },
    { id: 'foods_500', name: 'Glutton', description: 'Eat 500 total foods', unlocked: stats.totalFoodsEaten >= 500, icon: '🍴' },
    
    // Expert achievements 
    { id: 'score_10000', name: 'Legend', description: 'Score 10,000 points', unlocked: highScore >= 10000, icon: '⚡' },
    { id: 'score_12500', name: 'Snake Virtuoso', description: 'Score 12,500 points', unlocked: highScore >= 12500, icon: '🎯' },
    { id: 'games_100', name: 'Obsessed', description: 'Play 100 games', unlocked: stats.gamesPlayed >= 100, icon: '🤯' },
    { id: 'foods_1000', name: 'Food Vacuum', description: 'Eat 1,000 total foods', unlocked: stats.totalFoodsEaten >= 1000, icon: '🌪️' },
    
    // Ultimate achievements
    { id: 'score_15000', name: 'Untouchable', description: 'Score 15,000 points', unlocked: highScore >= 15000, icon: '💎' },
    { id: 'score_20000', name: 'Snake God', description: 'Score 20,000 points (legendary!)', unlocked: highScore >= 20000, icon: '👑' },
    { id: 'games_250', name: 'Intervention Needed', description: 'Play 250 games', unlocked: stats.gamesPlayed >= 250, icon: '😱' },
    { id: 'foods_2500', name: 'Bottomless Pit', description: 'Eat 2,500 total foods', unlocked: stats.totalFoodsEaten >= 2500, icon: '🕳️' },
    
    // Special achievements
    { id: 'high_scorer', name: 'High Scorer', description: 'Achieve a score higher than 750 points', unlocked: highScore >= 750, icon: '⭐' },
    { id: 'food_chain', name: 'Food Chain', description: 'Eat 50 foods in a single game', unlocked: highScore >= 500, icon: '🔗' },
    { id: 'marathon_player', name: 'Marathon Player', description: 'Play 15 games in a row', unlocked: stats.gamesPlayed >= 15, icon: '🏃' },
    { id: 'consistent', name: 'Consistent', description: 'Score over 200 points (achievable multiple times)', unlocked: highScore >= 200, icon: '🎯' },
    { id: 'explorer', name: 'Explorer', description: 'Try different game modes (play any game)', unlocked: stats.gamesPlayed >= 1, icon: '🗺️' },
    { id: 'veteran', name: 'Veteran', description: 'Reach a high score of 1500+ points', unlocked: highScore >= 1500, icon: '🎖️' }
  ];
  
  let html = '<div class="achievements-grid">';
  
  achievements.forEach(achievement => {
    html += `
      <div class="achievement ${achievement.unlocked ? 'unlocked' : 'locked'}">
        <div class="achievement-icon">${achievement.unlocked ? (achievement.icon || '🏆') : '🔒'}</div>
        <div class="achievement-info">
          <h4>${achievement.name}</h4>
          <p>${achievement.description}</p>
        </div>
      </div>
    `;
  });
  
  html += '</div>';
  achievementsContent.innerHTML = html;
}

function loadGameHistory() {
  const historyContent = document.getElementById('historyContent');
  if (!historyContent) {
    console.error('History content element not found');
    return;
  }
  
  const stats = JSON.parse(localStorage.getItem('pythonixStats') || '{"gamesPlayed": 0, "totalFoodsEaten": 0}');
  const gameHistory = JSON.parse(localStorage.getItem('pythonixGameHistory') || '[]');
  const highScore = parseInt(localStorage.getItem('pythonixHighScore') || '0');
  
  console.log('Loading history - Stats:', stats, 'History:', gameHistory, 'High score:', highScore);
  
  let html = '<div class="stats-overview">';
  html += `<div class="stat-item"><strong>Games Played:</strong> ${stats.gamesPlayed}</div>`;
  html += `<div class="stat-item"><strong>High Score:</strong> ${highScore}</div>`;
  html += `<div class="stat-item"><strong>Total Foods:</strong> ${stats.totalFoodsEaten}</div>`;
  html += `<div class="stat-item"><strong>Avg Score:</strong> ${stats.gamesPlayed > 0 ? Math.round((stats.totalScore || 0) / stats.gamesPlayed) : 0}</div>`;
  html += '</div>';
  
  html += '<h3>Recent Games</h3>';
  
  if (gameHistory.length === 0) {
    html += '<p>No games recorded yet. Play some games to see your history!</p>';
    html += '<p><em>Note: Your current high score of ' + highScore + ' shows you have played before, but detailed history wasn\'t being saved.</em></p>';
  } else {
    html += '<div class="history-list">';
    gameHistory.slice(-10).reverse().forEach(game => {
      const date = new Date(game.date).toLocaleDateString() + ' ' + new Date(game.date).toLocaleTimeString();
      html += `
        <div class="history-item">
          <div class="game-info">
            <span class="game-score">Score: ${game.score}</span>
            <span class="game-foods">Foods: ${game.foodsEaten || 0}</span>
            <span class="game-mode">${game.mode || 'Classic'}</span>
          </div>
          <div class="game-date">${date}</div>
        </div>
      `;
    });
    html += '</div>';
  }
  
  historyContent.innerHTML = html;
}

// Core game functions
function gameLoop() {
  if (isGameOver) return;
  
  // Handle pending direction change
  if (window.pendingDirection && isValidDirection(window.pendingDirection, direction)) {
    console.log('Changing direction from', direction, 'to', window.pendingDirection);
    direction = window.pendingDirection;
    window.direction = direction; // Keep window.direction in sync
    window.pendingDirection = null;
  }
  
  // Move snake head
  let head = { x: snake[0].x, y: snake[0].y };
  
  switch (direction) {
    case 'LEFT': head.x--; break;
    case 'RIGHT': head.x++; break;
    case 'UP': head.y--; break;
    case 'DOWN': head.y++; break;
  }
  
  // Handle wall wrapping
  if (head.x < 0) head.x = boardWidth - 1;
  if (head.x >= boardWidth) head.x = 0;
  if (head.y < 0) head.y = boardHeight - 1;
  if (head.y >= boardHeight) head.y = 0;
  
  if (snake.some(segment => segment.x === head.x && segment.y === head.y)) {
    endGame(); return;
  }
  
  snake.unshift(head);
  
  // Check food collision
  if (food && head.x === food.x && head.y === food.y) {
    handleFoodEaten();
  } else {
    snake.pop();
  }
  
  // Update score display continuously
  const scoreBoard = document.getElementById('scoreBoard');
  if (scoreBoard) scoreBoard.textContent = 'Score: ' + score;
  
  drawBoard();
}

function drawBoard() {
  if (!canvas || !ctx) return;
  if (!boardWidth || !boardHeight) resizeCanvas();

  // Background
  const bg = "#f7fffe";
  ctx.fillStyle = bg;
  ctx.fillRect(0, 0, canvas.width, canvas.height);

  // Grid
  const colorA = "#A8DBA8";
  const colorB = "#8CCF7E";
  const borderColor = "#6c7a89";
  for (let y = 0; y < boardHeight; y++) {
    for (let x = 0; x < boardWidth; x++) {
      ctx.fillStyle = ((x + y) % 2 === 0) ? colorA : colorB;
      ctx.fillRect(x * boxSize, y * boxSize, boxSize, boxSize);
      ctx.strokeStyle = borderColor;
      ctx.lineWidth = 1;
      ctx.strokeRect(x * boxSize, y * boxSize, boxSize, boxSize);
    }
  }

  // Draw snake
  if (Array.isArray(snake) && snake.length > 0) {
    if (snakeShape === 'emoji') {
      snake.forEach((segment, i) => {
        if (!segment) return;
        const cx = (segment.x + 0.5) * boxSize;
        const cy = (segment.y + 0.5) * boxSize;
        ctx.font = `${Math.floor(boxSize*0.9)}px serif`;
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillStyle = '#fff';
        ctx.fillText(snakeEmoji, cx, cy);
      });
    } else {
      // Get snake color/gradient
      const getSnakeColor = () => {
        if (snakeSkin === 'green') return '#4CAF50';
        if (snakeSkin === 'blueGradient') {
          const gradient = ctx.createLinearGradient(0, 0, boxSize, boxSize);
          gradient.addColorStop(0, '#4a90e2');
          gradient.addColorStop(0.5, '#357abd');
          gradient.addColorStop(1, '#2e6da4');
          return gradient;
        }
        if (snakeSkin === 'retroGradient') {
          const gradient = ctx.createLinearGradient(0, 0, boxSize, boxSize);
          gradient.addColorStop(0, '#ff6f91');
          gradient.addColorStop(0.5, '#ff8a80');
          gradient.addColorStop(1, '#ffa726');
          return gradient;
        }
        if (snakeSkin === 'rainbow') return `hsl(${Math.floor((performance.now()/50)%360)}, 90%, 55%)`;
        return '#4CAF50'; // default green
      };

      const snakeColor = getSnakeColor();
      ctx.fillStyle = snakeColor;
      
      snake.forEach((segment, i) => {
        if (!segment) return;
        const x = segment.x * boxSize;
        const y = segment.y * boxSize;
        ctx.fillRect(x, y, boxSize, boxSize);
      });
      
      // Add eyes to head
      if (snake[0]) {
        const head = snake[0];
        const cx = (head.x + 0.5) * boxSize;
        const cy = (head.y + 0.5) * boxSize;
        
        ctx.fillStyle = '#000';
        const eyeSize = boxSize * 0.12;
        const eyeOffset = boxSize * 0.22;
        
        let eye1X, eye1Y, eye2X, eye2Y;
        if (direction === 'UP') {
          eye1X = cx - eyeOffset; eye1Y = cy - eyeOffset;
          eye2X = cx + eyeOffset; eye2Y = cy - eyeOffset;
        } else if (direction === 'DOWN') {
          eye1X = cx - eyeOffset; eye1Y = cy + eyeOffset;
          eye2X = cx + eyeOffset; eye2Y = cy + eyeOffset;
        } else if (direction === 'LEFT') {
          eye1X = cx - eyeOffset; eye1Y = cy - eyeOffset;
          eye2X = cx - eyeOffset; eye2Y = cy + eyeOffset;
        } else {
          eye1X = cx + eyeOffset; eye1Y = cy - eyeOffset;
          eye2X = cx + eyeOffset; eye2Y = cy + eyeOffset;
        }
        
        ctx.beginPath();
        ctx.arc(eye1X, eye1Y, eyeSize, 0, Math.PI * 2);
        ctx.arc(eye2X, eye2Y, eyeSize, 0, Math.PI * 2);
        ctx.fill();
      }
    }
  }

  // Draw food
  if (food && typeof food.x === 'number' && typeof food.y === 'number') {
    const fx = (food.x + 0.5) * boxSize;
    const fy = (food.y + 0.5) * boxSize;
    
    if (food.type === 'normal') {
      ctx.beginPath(); 
      ctx.fillStyle = '#E32727';
      ctx.arc(fx, fy, boxSize * 0.4, 0, 2 * Math.PI); 
      ctx.fill();
      ctx.fillStyle = '#3B7A14';
      ctx.fillRect(fx + boxSize * 0.1, fy - boxSize * 0.4, boxSize * 0.15, boxSize * 0.2);
    } else if (food.type === 'power_double') {
      ctx.beginPath(); 
      ctx.fillStyle = '#FFD24D';
      ctx.arc(fx, fy, boxSize * 0.38, 0, 2 * Math.PI); 
      ctx.fill();
      ctx.fillStyle = '#222'; 
      ctx.font = `${Math.max(10, boxSize*0.4)}px sans-serif`; 
      ctx.textAlign='center'; 
      ctx.textBaseline='middle'; 
      ctx.fillText('2x', fx, fy);
    } else if (food.type === 'power_speed') {
      ctx.beginPath(); 
      ctx.fillStyle = '#4FD1C5';
      ctx.arc(fx, fy, boxSize * 0.38, 0, 2*Math.PI); 
      ctx.fill();
      ctx.fillStyle = '#022'; 
      ctx.font = `${Math.max(10, boxSize*0.45)}px sans-serif`; 
      ctx.textAlign='center'; 
      ctx.textBaseline='middle'; 
      ctx.fillText('⚡', fx, fy);
    }
  }
}

function handleFoodEaten() {
  // Play appropriate sound effect
  try {
    if (food.type === 'power_double' || food.type === 'power_speed') {
      powerSound.currentTime = 0; // Reset sound to start
      powerSound.play();
    } else {
      eatSound.currentTime = 0; // Reset sound to start
      eatSound.play();
    }
  } catch (e) {
    console.log('Sound playback failed:', e);
  }
  
  let points = 25;  // Increased from 10
  if (food.type === 'power_double') {
    multiplierActive = true;
    points = 50;  // Increased from 20
    multiplierTimeLeft = 10;
    // Set 2x points for 10 seconds with timer display
    clearTimeout(multiplierInterval);
    const startTime = Date.now();
    const updateTimer = () => {
      const elapsed = Math.floor((Date.now() - startTime) / 1000);
      const remaining = Math.max(0, 10 - elapsed);
      updateMultiplierDisplay(remaining);
      if (remaining > 0) {
        setTimeout(updateTimer, 1000);
      }
    };
    updateTimer();
    multiplierInterval = setTimeout(() => {
      multiplierActive = false;
      updateMultiplierDisplay(0);
      console.log('2x points expired');
    }, 10000);
  } else if (food.type === 'power_speed') {
    points = 40;  // Increased from 15
    speedTimeLeft = 8;
    // Set 1.5x speed for 8 seconds with timer display
    speed = Math.max(50, Math.floor(speed / 1.5)); // 1.5x speed (reduced interval)
    clearInterval(gameInterval);
    gameInterval = setInterval(gameLoop, speed);
    clearTimeout(speedInterval);
    const startTime = Date.now();
    const updateTimer = () => {
      const elapsed = Math.floor((Date.now() - startTime) / 1000);
      const remaining = Math.max(0, 8 - elapsed);
      updateSpeedDisplay(remaining);
      if (remaining > 0) {
        setTimeout(updateTimer, 1000);
      }
    };
    updateTimer();
    speedInterval = setTimeout(() => {
      speed = baseSpeed;
      clearInterval(gameInterval);
      gameInterval = setInterval(gameLoop, speed);
      updateSpeedDisplay(0);
      console.log('1.5x speed expired');
    }, 8000);
  }
  
  if (multiplierActive) points *= 2;
  score += points;
  foodsEaten++;
  
  // Update current foods eaten in stats
  const stats = JSON.parse(localStorage.getItem('pythonixStats') || '{}');
  stats.totalFoodsEaten = (stats.totalFoodsEaten || 0) + 1;
  localStorage.setItem('pythonixStats', JSON.stringify(stats));
  updateStatsDisplay();
  
  // Time attack mode: add 1 second per food eaten
  if (gameMode === 'time') {
    gameTimeLeft += 1;
    updateTimeDisplay();
    console.log('Time attack: +1 second! New time:', gameTimeLeft);
  }
  
  // Progressive difficulty for hard mode
  if (gameMode === 'hard' && foodsEaten % 5 === 0) {
    // Every 5 foods, increase speed slightly
    speed = Math.max(50, speed - 5);
    clearInterval(gameInterval);
    gameInterval = setInterval(gameLoop, speed);
    console.log('Hard mode speed increased to:', speed);
  }
  
  // Update UI elements - fix selector
  const scoreBoard = document.getElementById('scoreBoard');
  if (scoreBoard) scoreBoard.textContent = 'Score: ' + score;
  
  food = randomFood();
}

function endGame() {
  isGameOver = true;
  clearInterval(gameInterval);
  
  // Play game over sound
  try {
    gameOverSound.currentTime = 0; // Reset sound to start
    gameOverSound.play();
  } catch (e) {
    console.log('Game over sound playback failed:', e);
  }
  
  // Update high score
  const highScore = parseInt(localStorage.getItem('pythonixHighScore') || '0');
  if (score > highScore) {
    localStorage.setItem('pythonixHighScore', score);
  }
  
  // Show game over screen
  const gameOverScreen = document.getElementById('gameOverScreen');
  if (gameOverScreen) {
    const gameOverText = gameOverScreen.querySelector('h2');
    if (gameOverText) gameOverText.textContent = `Game Over! Score: ${score}`;
    gameOverScreen.style.display = 'flex';
  } else {
    alert(`Game Over! Score: ${score}`);
  }
}

// Make sure the navbar buttons work
document.addEventListener('DOMContentLoaded', function() {
  // Find achievements button and add click handler
  const achievementsBtn = document.querySelector('button[onclick*="showAchievements"]') || 
                           document.querySelector('.small-btn:nth-child(1)');
  if (achievementsBtn) {
    achievementsBtn.onclick = showAchievements;
    console.log('Achievements button found and connected');
  }
  
  // Find history button and add click handler  
  const historyBtn = document.querySelector('button[onclick*="showGameHistory"]') ||
                     document.querySelector('.small-btn:nth-child(2)');
  if (historyBtn) {
    historyBtn.onclick = showGameHistory;
    console.log('History button found and connected');
  }
});

// Update all stats displays
function updateStatsDisplay() {
  // Update high score
  const highScore = parseInt(localStorage.getItem('pythonixHighScore') || '0');
  const highScoreNav = document.getElementById('highScoreNav');
  if (highScoreNav) highScoreNav.textContent = 'High Score: ' + highScore;
  
  // Update total foods eaten from localStorage
  const totalStats = JSON.parse(localStorage.getItem('pythonixStats') || '{}');
  const totalFoodsEaten = totalStats.totalFoodsEaten || 0;
  const foodsEatenNav = document.getElementById('foodsEatenNav');
  if (foodsEatenNav) foodsEatenNav.textContent = 'Foods Eaten: ' + totalFoodsEaten;
}

// Update multiplier timer display
function updateMultiplierDisplay(timeLeft) {
  const multiplierNav = document.getElementById('multiplierNav');
  if (multiplierNav) {
    if (multiplierActive && timeLeft > 0) {
      multiplierNav.textContent = `2x Points (${timeLeft}s)`;
      multiplierNav.style.display = 'inline';
    } else {
      multiplierNav.style.display = 'none';
    }
  }
}

// Update speed timer display
function updateSpeedDisplay(timeLeft) {
  const speedNav = document.getElementById('speedNav');
  if (!speedNav) {
    // Create speed display if it doesn't exist
    const navStats = document.querySelector('.nav-stats');
    if (navStats) {
      const speedSpan = document.createElement('span');
      speedSpan.className = 'stat-item';
      speedSpan.id = 'speedNav';
      speedSpan.style.display = 'none';
      navStats.appendChild(speedSpan);
    }
  }
  const speedDisplay = document.getElementById('speedNav');
  if (speedDisplay) {
    if (speed < baseSpeed && timeLeft > 0) {
      speedDisplay.textContent = `1.5x Speed (${timeLeft}s)`;
      speedDisplay.style.display = 'inline';
    } else {
      speedDisplay.style.display = 'none';
    }
  }
}

// Initialize game mode specific features
function initGameMode() {
  const gameModeSelect = document.getElementById('gameMode');
  const selectedMode = gameModeSelect ? gameModeSelect.value : 'classic';
  gameMode = selectedMode;
  
  // Clear any existing game mode timers
  clearInterval(gameTimeInterval);
  
  // Show/hide mode-specific controls
  const timeAttackDisplay = document.getElementById('timeAttackDisplay');
  
  if (gameMode === 'time') {
    if (timeAttackDisplay) timeAttackDisplay.style.display = 'inline';
    // Initialize time attack (60 seconds, +1 second per food)
    gameTimeLeft = 60;
    updateTimeDisplay();
    gameTimeInterval = setInterval(updateGameTimer, 1000);
  } else {
    if (timeAttackDisplay) timeAttackDisplay.style.display = 'none';
    
    // Set different starting speeds for classic vs hard mode
    if (gameMode === 'hard') {
      // Hard mode: starts faster and gets progressively harder
      baseSpeed = 120; // Faster starting speed
      speed = baseSpeed;
    } else {
      // Classic mode: normal starting speed
      baseSpeed = 150;
      speed = baseSpeed;
    }
  }
}

// Update time attack display
function updateTimeDisplay() {
  const timeLeftSpan = document.getElementById('timeLeft');
  if (timeLeftSpan && gameMode === 'time') {
    timeLeftSpan.textContent = gameTimeLeft;
  }
}

// Game timer for time attack mode
function updateGameTimer() {
  if (gameMode === 'time' && gameTimeLeft > 0) {
    gameTimeLeft--;
    updateTimeDisplay();
    if (gameTimeLeft <= 0) {
      endGame();
    }
  }
}

// Update endGame function to save game data for history/achievements
const originalEndGame = endGame;
endGame = function() {
  // Save game data
  const stats = JSON.parse(localStorage.getItem('pythonixStats') || '{"gamesPlayed": 0, "totalFoodsEaten": 0, "totalScore": 0}');
  const gameHistory = JSON.parse(localStorage.getItem('pythonixGameHistory') || '[]');
  
  // Update stats
  stats.gamesPlayed = (stats.gamesPlayed || 0) + 1;
  stats.totalFoodsEaten = (stats.totalFoodsEaten || 0) + (foodsEaten || 0);
  stats.totalScore = (stats.totalScore || 0) + (score || 0);
  
  // Save game to history
  gameHistory.push({
    score: score || 0,
    foodsEaten: foodsEaten || 0,
    mode: gameMode || 'Classic',
    date: new Date().toISOString()
  });
  
  // Keep only last 50 games
  if (gameHistory.length > 50) {
    gameHistory.splice(0, gameHistory.length - 50);
  }
  
  // Save to localStorage
  localStorage.setItem('pythonixStats', JSON.stringify(stats));
  localStorage.setItem('pythonixGameHistory', JSON.stringify(gameHistory));
  
  console.log('Game saved - Score:', score, 'Foods:', foodsEaten, 'Stats:', stats);
  
  // Call original endGame
  if (originalEndGame) originalEndGame();
};

// Add missing core game functions
function initGame() {
  console.log('Initializing game...');
  
  // Initialize canvas and board
  resizeCanvas();
  
  // Initialize game variables
  snake = [{x: Math.floor(boardWidth/2), y: Math.floor(boardHeight/2)}];
  direction = 'RIGHT';
  window.direction = 'RIGHT';
  window.pendingDirection = null;
  score = 0;
  foodsEaten = 0;
  isGameOver = false;
  multiplierActive = false;
  speed = baseSpeed;
  
  // Clear any existing timers
  clearTimeout(multiplierInterval);
  clearTimeout(speedInterval);
  
  // Initialize food
  food = randomFood();
  
  // Update all displays
  updateStatsDisplay();
  const scoreBoard = document.getElementById('scoreBoard');
  if (scoreBoard) scoreBoard.textContent = 'Score: ' + score;
  
  // Initialize game mode specific features
  initGameMode();
  
  // Ensure keyboard handler is connected
  console.log('Game initialized - Snake at:', snake[0], 'Direction:', direction);
  
  // Start game loop
  clearInterval(gameInterval);
  gameInterval = setInterval(gameLoop, speed || 150);
  
  // Draw initial board
  drawBoard();
}

function startGame() {
  console.log('Starting game...');
  
  // Hide intro screen
  const introScreen = document.getElementById('introScreen');
  if (introScreen) {
    introScreen.style.display = 'none';
  }
  
  // Show game canvas
  const canvas = document.getElementById('gameCanvas');
  if (canvas) {
    canvas.style.display = 'block';
  }
  
  // Initialize the game
  initGame();
}

function restartGame() {
  console.log('Restarting game...');
  
  // Stop game over sound immediately
  try {
    gameOverSound.pause();
    gameOverSound.currentTime = 0;
  } catch (e) {
    console.log('Could not stop game over sound:', e);
  }
  
  // Hide game over screen
  const gameOverScreen = document.getElementById('gameOverScreen');
  if (gameOverScreen) {
    gameOverScreen.style.display = 'none';
  }
  
  // Restart the game
  initGame();
}

// Connect all buttons when DOM is ready
document.addEventListener('DOMContentLoaded', function() {
  console.log('DOM loaded, connecting buttons...');
  
  // Connect Start Game button
  const startBtn = document.getElementById('startBtn');
  if (startBtn) {
    startBtn.onclick = startGame;
    console.log('Start button connected');
  } else {
    console.error('Start button not found');
  }
  
  // Connect History button
  const historyBtn = document.getElementById('showHistory');
  if (historyBtn) {
    historyBtn.onclick = showGameHistory;
    console.log('History button connected');
  }
  
  // Connect Achievements button
  const achievementsBtn = document.getElementById('showAchievements');
  if (achievementsBtn) {
    achievementsBtn.onclick = showAchievements;
    console.log('Achievements button connected');
  }
  
  // Connect Clear Games button
  const clearBtn = document.getElementById('clearGames');
  if (clearBtn) {
    clearBtn.onclick = clearAllGameData;
    console.log('Clear Games button connected');
  }
  
  // Connect Theme selector
  const themeSelect = document.getElementById('themeSelect');
  if (themeSelect) {
    themeSelect.addEventListener('change', function() {
      changeTheme(this.value);
    });
    
    // Set initial theme
    const savedTheme = localStorage.getItem('pythonixTheme') || 'day';
    themeSelect.value = savedTheme;
    changeTheme(savedTheme);
    console.log('Theme selector connected');
  }
  
  // Connect Snake Skin selector
  const snakeSkinSelect = document.getElementById('snakeSkin');
  if (snakeSkinSelect) {
    snakeSkinSelect.addEventListener('change', function() {
      snakeSkin = this.value;
      localStorage.setItem('pythonixSnakeSkin', snakeSkin);
      console.log('Snake skin changed to:', snakeSkin);
    });
    
    // Set initial skin
    const savedSkin = localStorage.getItem('pythonixSnakeSkin') || 'green';
    snakeSkinSelect.value = savedSkin;
    snakeSkin = savedSkin;
    console.log('Snake skin selector connected');
  }
  
  // Connect Snake Shape selector
  const snakeShapeSelect = document.getElementById('snakeShape');
  const emojiPickerContainer = document.getElementById('emojiPickerContainer');
  if (snakeShapeSelect) {
    snakeShapeSelect.addEventListener('change', function() {
      snakeShape = this.value;
      localStorage.setItem('pythonixSnakeShape', snakeShape);
      
      // Show/hide emoji picker based on selection
      if (snakeShape === 'emoji') {
        emojiPickerContainer.style.display = 'inline';
      } else {
        emojiPickerContainer.style.display = 'none';
      }
      
      console.log('Snake shape changed to:', snakeShape);
    });
    
    // Set initial shape
    const savedShape = localStorage.getItem('pythonixSnakeShape') || 'square';
    snakeShapeSelect.value = savedShape;
    snakeShape = savedShape;
    
    // Show emoji picker if needed
    if (snakeShape === 'emoji') {
      emojiPickerContainer.style.display = 'inline';
    }
    
    console.log('Snake shape selector connected');
  }
  
  // Connect Emoji Picker
  const emojiPicker = document.getElementById('emojiPicker');
  if (emojiPicker) {
    // Handle input changes
    emojiPicker.addEventListener('input', function() {
      const inputValue = this.value.trim();
      
      // Basic validation - allow any text but prefer emojis
      if (inputValue.length > 0) {
        snakeEmoji = inputValue;
        localStorage.setItem('pythonixSnakeEmoji', snakeEmoji);
        console.log('Snake emoji changed to:', snakeEmoji);
      }
    });
    
    // Handle paste events for better emoji support
    emojiPicker.addEventListener('paste', function(e) {
      setTimeout(() => {
        const inputValue = this.value.trim();
        if (inputValue.length > 0) {
          snakeEmoji = inputValue;
          localStorage.setItem('pythonixSnakeEmoji', snakeEmoji);
          console.log('Snake emoji pasted:', snakeEmoji);
        }
      }, 10);
    });
    
    // Set initial emoji
    const savedEmoji = localStorage.getItem('pythonixSnakeEmoji') || '🐍';
    snakeEmoji = savedEmoji;
    emojiPicker.value = snakeEmoji;
    
    console.log('Emoji picker connected');
  }
  
  // Connect Game Mode selector
  const gameModeSelect = document.getElementById('gameMode');
  if (gameModeSelect) {
    gameModeSelect.addEventListener('change', function() {
      gameMode = this.value;
      initGameMode();
      console.log('Game mode changed to:', gameMode);
    });
  }
  
  // Connect Level controls
  const prevLevelBtn = document.getElementById('prevLevel');
  const nextLevelBtn = document.getElementById('nextLevel');
  const levelDisplay = document.getElementById('levelDisplay');
  let currentLevel = 1;
  
  if (prevLevelBtn) {
    prevLevelBtn.addEventListener('click', function() {
      if (currentLevel > 1) {
        currentLevel--;
        levelDisplay.textContent = currentLevel;
      }
    });
  }
  
  if (nextLevelBtn) {
    nextLevelBtn.addEventListener('click', function() {
      if (currentLevel < 10) {  // Max 10 levels
        currentLevel++;
        levelDisplay.textContent = currentLevel;
      }
    });
  }
  
  // Initialize stats display
  updateStatsDisplay();
  
  console.log('All buttons connected successfully');
});

// Theme changing function
function changeTheme(themeName) {
  console.log('Changing theme to:', themeName);
  
  // Remove all existing theme classes
  document.body.className = document.body.className.replace(/theme-\w+/g, '');
  
  // Handle auto theme (day/night based on time)
  if (themeName === 'auto') {
    const hour = new Date().getHours();
    themeName = (hour >= 6 && hour < 18) ? 'day' : 'night';
  }
  
  // Add new theme class
  document.body.classList.add('theme-' + themeName);
  
  // Save theme preference
  localStorage.setItem('pythonixTheme', themeName);
  
  console.log('Applied theme class: theme-' + themeName);
}

// Make sure keyboard handler is working
window.addEventListener('load', function() {
  console.log('Window loaded, setting up keyboard handler...');
  window.pendingDirection = null;
  window.direction = 'RIGHT';
  
  // Test keyboard handler
  console.log('Keyboard handler should be active. Try pressing arrow keys.');
  
  // Add extra key listener as backup
  document.addEventListener('keydown', function(e) {
    if (isGameOver) return;
    const key = e.key.toLowerCase();
    console.log('Key pressed:', key);
    
    if (key === 'arrowleft' || key === 'a') {
      window.pendingDirection = 'LEFT';
    } else if (key === 'arrowright' || key === 'd') {
      window.pendingDirection = 'RIGHT';
    } else if (key === 'arrowup' || key === 'w') {
      window.pendingDirection = 'UP';
    } else if (key === 'arrowdown' || key === 's') {
      window.pendingDirection = 'DOWN';
    }
    
    if (['arrowup','arrowdown','arrowleft','arrowright'].includes(key)) {
      e.preventDefault();
    }
  });
});
</script>
</body>
</html>